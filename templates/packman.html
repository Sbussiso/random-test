{% extends "base.html" %}
{% block title %}PackMan{% endblock %}
{% block content %}
<header class="bg-primary text-white text-center py-3">
    <h1>Pack Panel</h1>
</header>
<br/>
<br/>
<div class="container">
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Step 1. Data
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <form id="packNameForm">
                        <label for="packName" class="form-label">Pack Name (Required)</label>
                        <input type="text" class="form-control" id="packName" name="pack_name" aria-describedby="pack-name">
                    </form>
                    <br/>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Choose Data Type
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showMessage('file')">File</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showMessage('webpage')">Webpage</a></li>
                        </ul>
                    </div>
                    <div id="message" class="mt-3"></div>
                    <div id="dataEntries" class="mt-3"></div>
                    <br/>
                    <button type="button" class="btn btn-primary" id="reviewButton" style="display: none;" onclick="openAccordionTwo()">Review Pack Data</button>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Step 2. Confirm Pack
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div id="packagedData">No Data to pack</div>
                    <div id="previewData"></div>
                    <br/>
                    <button class="btn btn-primary" onclick="publishPack()">Publish to Pack</button>
                </div>
            </div>
        </div>
    </div>
</div>
<br/>
<br/>
<script>
    const webPackData = [];
    const filePackData = [];

    function showMessage(type) {
        const messageDiv = document.getElementById('message');
        const packNameValue = document.getElementById('packName').value;
        if (type === 'file') {
            messageDiv.innerHTML = `
                <p class="text-danger">You are about to add a file.</p>
                <form id="fileForm" enctype="multipart/form-data" onsubmit="submitFile(event)">
                    <input type="file" name="file" class="form-control mt-2" required>
                    <input type="hidden" name="pack_name" value="${packNameValue}">
                    <br/>
                    <button type="submit" class="btn btn-primary">Add Data</button>
                </form>
            `;
        } else if (type === 'webpage') {
            messageDiv.innerHTML = `
                <p class="text-info">You are about to add a webpage.</p>
                <form id="linkForm" onsubmit="submitLink(event)">
                    <input type="url" name="link" class="form-control mt-2" placeholder="Enter web link" required>
                    <input type="hidden" name="pack_name" value="${packNameValue}">
                    <br/>
                    <button type="submit" class="btn btn-primary">Add Data</button>
                </form>
            `;
        }
    }

    function disablePackName() {
        document.getElementById('packName').disabled = true;
    }

    function addDataEntry(type, value) {
        const dataEntries = document.getElementById('dataEntries');
        const entry = document.createElement('div');
        entry.classList.add('mt-2');
        entry.innerHTML = `
            <input type="text" class="form-control" value="${type}: ${value}" disabled>
        `;
        dataEntries.appendChild(entry);

        document.getElementById('reviewButton').style.display = 'block';
    }

    function submitLink(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const link = formData.get('link');
        const packName = formData.get('pack_name');

        webPackData.push({ content: link });
        addDataEntry('Link', link);
        form.reset();
        disablePackName();
    }

    function submitFile(event) {
        event.preventDefault();
        const form = event.target;
        const fileInput = form.querySelector('input[name="file"]');
        const file = fileInput.files[0];
        const packName = form.querySelector('input[name="pack_name"]').value;

        filePackData.push({ file: file, pack_name: packName });
        addDataEntry('File', file.name);
        form.reset();
        disablePackName();
    }

    function openAccordionTwo() {
        const collapseTwo = new bootstrap.Collapse(document.getElementById('collapseTwo'), {
            toggle: false
        });
        collapseTwo.show();

        const dataEntries = document.getElementById('dataEntries').querySelectorAll('input');
        let packagedDataContent = '';
        dataEntries.forEach((entry, index) => {
            packagedDataContent += `<p>${entry.value}</p>`;
        });
        document.getElementById('packagedData').innerHTML = packagedDataContent || 'No Data to pack';

        // Fetch and display preview data
        fetchPreviewData();
    }

    function fetchPreviewData() {
        const previewDataDiv = document.getElementById('previewData');
        previewDataDiv.innerHTML = ''; // Clear previous previews

        // Fetch preview data for links
        webPackData.forEach((entry, index) => {
            fetch('/packman/preview_link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ link: entry.content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Link processed successfully') {
                    const previewContent = data.docs.map(doc => doc.content).join('<br/>');
                    const accordionItem = createAccordionItem(`Link ${index + 1}`, previewContent);
                    previewDataDiv.appendChild(accordionItem);
                } else {
                    console.error('Failed to fetch preview for link:', data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // Fetch preview data for files
        filePackData.forEach((entry, index) => {
            const formData = new FormData();
            formData.append('file', entry.file);

            fetch('/packman/preview_file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'File processed successfully') {
                    const previewContent = data.content;
                    const accordionItem = createAccordionItem(`File ${index + 1}`, previewContent);
                    previewDataDiv.appendChild(accordionItem);
                } else {
                    console.error('Failed to fetch preview for file:', data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }

    function createAccordionItem(title, content) {
        const item = document.createElement('div');
        item.classList.add('accordion-item');
        item.innerHTML = `
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse${title.replace(/\s+/g, '')}" aria-expanded="false" aria-controls="flush-collapse${title.replace(/\s+/g, '')}">
                    ${title}
                </button>
            </h2>
            <div id="flush-collapse${title.replace(/\s+/g, '')}" class="accordion-collapse collapse" data-bs-parent="#previewData">
                <div class="accordion-body text-wrap">${content}</div>
            </div>
        `;
        return item;
    }

    function publishPack() {
        const packName = document.getElementById('packName').value;
        if (!packName) {
            alert('Pack name is required');
            return;
        }

        const token = sessionStorage.getItem('access_token');

        // Handle web pack data
        if (webPackData.length > 0) {
            fetch('/packman/web_pack', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pack_name: packName, docs: webPackData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Link processed successfully') {
                    alert('Links processed successfully');
                } else {
                    alert('Failed to process links');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to process links');
            });
        }

        // Handle file pack data
        const filePackPromises = filePackData.map(fileEntry => {
            const formData = new FormData();
            formData.append('pack_name', fileEntry.pack_name);
            formData.append('file', fileEntry.file);

            return fetch('/packman/file_pack', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'File uploaded successfully') {
                    alert(`File ${fileEntry.file.name} uploaded successfully`);
                } else {
                    alert(`Failed to upload file ${fileEntry.file.name}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Failed to upload file ${fileEntry.file.name}`);
            });
        });

        Promise.all(filePackPromises)
        .then(() => {
            alert('All files uploaded successfully');
            document.getElementById('dataEntries').innerHTML = '';
            document.getElementById('packagedData').innerText = 'No Data to pack';
            document.getElementById('packNameForm').reset();
            document.getElementById('packName').disabled = false;
            document.getElementById('reviewButton').style.display = 'none';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to upload files');
        });
    }
</script>
{% endblock %}
